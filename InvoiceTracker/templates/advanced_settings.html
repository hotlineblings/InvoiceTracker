{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h2>‚öôÔ∏è Ustawienia zaawansowane - {{ account.name }}</h2>
      <p class="text-muted">
        Skonfiguruj harmonogram automatycznych operacji dla tego profilu.
        <br>
        <strong>‚è±Ô∏è Uwaga:</strong> Zmiany bƒôdƒÖ aktywne od nastƒôpnego dnia.
      </p>

      <hr>

      <form method="post" id="advancedSettingsForm">

        <!-- SEKCJA: WYSY≈ÅKA POWIADOMIE≈É -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">üìß Wysy≈Çka powiadomie≈Ñ</h4>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="is_mail_enabled"
                         name="is_mail_enabled" {% if settings.is_mail_enabled %}checked{% endif %}>
                  <label class="form-check-label" for="is_mail_enabled">
                    <strong>W≈ÇƒÖcz automatycznƒÖ wysy≈Çkƒô powiadomie≈Ñ</strong>
                  </label>
                </div>
                <small class="form-text text-muted">
                  Gdy wy≈ÇƒÖczone, system nie bƒôdzie wysy≈Ça≈Ç emaili dla tego profilu
                </small>
              </div>
            </div>

            <div class="row" id="mail_time_settings">
              <div class="col-md-3">
                <label for="mail_send_hour" class="form-label">Godzina (UTC)</label>
                <input type="number" class="form-control" id="mail_send_hour"
                       name="mail_send_hour" value="{{ settings.mail_send_hour }}"
                       min="0" max="23" required>
                <small class="form-text text-muted">0-23</small>
              </div>

              <div class="col-md-3">
                <label for="mail_send_minute" class="form-label">Minuta</label>
                <input type="number" class="form-control" id="mail_send_minute"
                       name="mail_send_minute" value="{{ settings.mail_send_minute }}"
                       min="0" max="59" required>
                <small class="form-text text-muted">0-59</small>
              </div>

              <div class="col-md-6">
                <label for="timezone" class="form-label">Strefa czasowa</label>
                <select class="form-select" id="timezone" name="timezone">
                  <option value="Europe/Warsaw" {% if settings.timezone == 'Europe/Warsaw' %}selected{% endif %}>
                    Europe/Warsaw (UTC+1/+2)
                  </option>
                  <option value="UTC" {% if settings.timezone == 'UTC' %}selected{% endif %}>
                    UTC (czas uniwersalny)
                  </option>
                  <option value="Europe/London" {% if settings.timezone == 'Europe/London' %}selected{% endif %}>
                    Europe/London (UTC+0/+1)
                  </option>
                </select>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-12">
                <div class="alert alert-info mb-0" role="alert">
                  ‚ÑπÔ∏è <strong>Godzina lokalna:</strong> <span id="mail_local_time_display">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SEKCJA: SYNCHRONIZACJA -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white">
            <h4 class="mb-0">üîÑ Synchronizacja danych</h4>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="is_sync_enabled"
                         name="is_sync_enabled" {% if settings.is_sync_enabled %}checked{% endif %}>
                  <label class="form-check-label" for="is_sync_enabled">
                    <strong>W≈ÇƒÖcz automatycznƒÖ synchronizacjƒô</strong>
                  </label>
                </div>
                <small class="form-text text-muted">
                  Gdy wy≈ÇƒÖczone, synchronizacja mo≈ºliwa tylko rƒôcznie
                </small>
              </div>
            </div>

            <div class="row" id="sync_time_settings">
              <div class="col-md-3">
                <label for="sync_hour" class="form-label">Godzina (UTC)</label>
                <input type="number" class="form-control" id="sync_hour"
                       name="sync_hour" value="{{ settings.sync_hour }}"
                       min="0" max="23" required>
                <small class="form-text text-muted">0-23</small>
              </div>

              <div class="col-md-3">
                <label for="sync_minute" class="form-label">Minuta</label>
                <input type="number" class="form-control" id="sync_minute"
                       name="sync_minute" value="{{ settings.sync_minute }}"
                       min="0" max="59" required>
                <small class="form-text text-muted">0-59</small>
              </div>

              <div class="col-md-6">
                <div class="alert alert-info mb-0" role="alert">
                  ‚ÑπÔ∏è <strong>Godzina lokalna:</strong> <span id="sync_local_time_display">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SEKCJA: POBIERANIE FAKTUR -->
        <div class="card mb-4">
          <div class="card-header bg-warning text-dark">
            <h4 class="mb-0">üìä Pobieranie faktur</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <label for="invoice_fetch_days_before" class="form-label">
                  Pobieraj faktury przed terminem p≈Çatno≈õci
                </label>
                <div class="input-group">
                  <input type="number" class="form-control" id="invoice_fetch_days_before"
                         name="invoice_fetch_days_before"
                         value="{{ settings.invoice_fetch_days_before }}"
                         min="1" max="30" required>
                  <span class="input-group-text">dni</span>
                </div>
                <small class="form-text text-muted">
                  Ile dni przed terminem p≈Çatno≈õci system ma pobraƒá fakturƒô do aktywnych spraw (1-30)
                </small>
              </div>

              <div class="col-md-6">
                <div class="alert alert-light border" role="alert">
                  <strong>Przyk≈Çad:</strong><br>
                  Ustawienie <code>7 dni</code> oznacza, ≈ºe faktura z terminem <strong>29.10.2025</strong>
                  zostanie pobrana ju≈º <strong>22.10.2025</strong> podczas synchronizacji.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SEKCJA: OPCJE DODATKOWE -->
        <div class="card mb-4">
          <div class="card-header bg-secondary text-white">
            <h4 class="mb-0">üéõÔ∏è Opcje dodatkowe</h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-12">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="auto_close_after_stage5"
                         name="auto_close_after_stage5" {% if settings.auto_close_after_stage5 %}checked{% endif %}>
                  <label class="form-check-label" for="auto_close_after_stage5">
                    <strong>Automatyczne zamykanie sprawy po wys≈Çaniu Stage 5</strong>
                  </label>
                </div>
                <small class="form-text text-muted">
                  Gdy w≈ÇƒÖczone, sprawa automatycznie zostanie zamkniƒôta jako "nieop≈Çacona" po wys≈Çaniu ostatniego powiadomienia (Przekazanie do windykatora)
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- PRZYCISKI -->
        <div class="row">
          <div class="col-md-12">
            <button type="submit" class="btn btn-primary btn-lg">
              üíæ Zapisz ustawienia
            </button>
            <a href="{{ url_for('active_cases') }}" class="btn btn-secondary btn-lg">
              ‚ùå Anuluj
            </a>
            <button type="button" class="btn btn-outline-warning btn-lg float-end" id="resetBtn">
              üîÑ Przywr√≥ƒá domy≈õlne
            </button>
          </div>
        </div>

      </form>

      <!-- INFO BOX -->
      <div class="alert alert-info mt-4" role="alert">
        <h5 class="alert-heading">üí° Informacje wa≈ºne</h5>
        <ul class="mb-0">
          <li><strong>Czasy sƒÖ w UTC</strong> - system przelicza na czas lokalny w podglƒÖdzie</li>
          <li><strong>Zmiany aktywne od nastƒôpnego dnia</strong> - wymaga restartu schedulera</li>
          <li><strong>Synchronizacja sprawdzana co godzinƒô</strong> - CRON uruchamia siƒô co 60 minut</li>
          <li><strong>Wysy≈Çka uruchamiana precyzyjnie</strong> - APScheduler w dok≈Çadnie ustawionym czasie</li>
        </ul>
      </div>

    </div>
  </div>
</div>

<script>
// Real-time conversion UTC ‚Üí Local time
document.addEventListener('DOMContentLoaded', function() {
  const mailHourInput = document.getElementById('mail_send_hour');
  const mailMinuteInput = document.getElementById('mail_send_minute');
  const syncHourInput = document.getElementById('sync_hour');
  const syncMinuteInput = document.getElementById('sync_minute');
  const timezoneSelect = document.getElementById('timezone');

  const mailLocalDisplay = document.getElementById('mail_local_time_display');
  const syncLocalDisplay = document.getElementById('sync_local_time_display');

  function updateLocalTimes() {
    const timezone = timezoneSelect.value;

    // Mail time
    const mailHour = parseInt(mailHourInput.value) || 0;
    const mailMinute = parseInt(mailMinuteInput.value) || 0;
    const mailUTC = new Date(Date.UTC(2025, 0, 1, mailHour, mailMinute));
    const mailLocal = mailUTC.toLocaleTimeString('pl-PL', {
      timeZone: timezone,
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
    mailLocalDisplay.textContent = mailLocal + ' (' + timezone + ')';

    // Sync time
    const syncHour = parseInt(syncHourInput.value) || 0;
    const syncMinute = parseInt(syncMinuteInput.value) || 0;
    const syncUTC = new Date(Date.UTC(2025, 0, 1, syncHour, syncMinute));
    const syncLocal = syncUTC.toLocaleTimeString('pl-PL', {
      timeZone: timezone,
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
    syncLocalDisplay.textContent = syncLocal + ' (' + timezone + ')';
  }

  // Event listeners
  mailHourInput.addEventListener('input', updateLocalTimes);
  mailMinuteInput.addEventListener('input', updateLocalTimes);
  syncHourInput.addEventListener('input', updateLocalTimes);
  syncMinuteInput.addEventListener('input', updateLocalTimes);
  timezoneSelect.addEventListener('change', updateLocalTimes);

  // Initial update
  updateLocalTimes();

  // Reset button
  document.getElementById('resetBtn').addEventListener('click', function() {
    if (confirm('Czy na pewno chcesz przywr√≥ciƒá domy≈õlne ustawienia?')) {
      mailHourInput.value = 7;
      mailMinuteInput.value = 0;
      syncHourInput.value = 9;
      syncMinuteInput.value = 0;
      document.getElementById('invoice_fetch_days_before').value = 1;
      timezoneSelect.value = 'Europe/Warsaw';
      document.getElementById('is_mail_enabled').checked = true;
      document.getElementById('is_sync_enabled').checked = true;
      document.getElementById('auto_close_after_stage5').checked = true;
      updateLocalTimes();
    }
  });

  // Toggle visibility based on checkboxes
  document.getElementById('is_mail_enabled').addEventListener('change', function() {
    const settings = document.getElementById('mail_time_settings');
    settings.style.opacity = this.checked ? '1' : '0.5';
  });

  document.getElementById('is_sync_enabled').addEventListener('change', function() {
    const settings = document.getElementById('sync_time_settings');
    settings.style.opacity = this.checked ? '1' : '0.5';
  });
});
</script>

<style>
.card-header h4 {
  margin: 0;
}

.form-check-input:checked {
  background-color: #198754;
  border-color: #198754;
}

#mail_time_settings,
#sync_time_settings {
  transition: opacity 0.3s ease;
}
</style>

{% endblock %}
