{% extends "layout.html" %}
{% block content %}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="page-title">
    <i class="bi bi-folder-open me-2"></i>
    Lista Spraw Windykacyjnych (Aktywne)
  </h2>
  <div>
    <a href="{{ url_for('manual_sync') }}" class="btn btn-info">
      <i class="bi bi-arrow-clockwise me-1"></i>
      Ręcznie Synchronizuj
    </a>
  </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-6">
    <div class="card-custom card-gradient-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-white-50 mb-1">Łączna kwota zadłużenia</p>
            <h3 class="mb-0 text-white">{{ "%.2f"|format(total_debt_all) }} zł</h3>
          </div>
          <div class="stat-icon">
            <i class="bi bi-cash-stack"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card-custom card-gradient-secondary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-white-50 mb-1">Liczba spraw aktywnych</p>
            <h3 class="mb-0 text-white">{{ active_count }}</h3>
          </div>
          <div class="stat-icon">
            <i class="bi bi-file-earmark-text"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Search and Filter Form -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-funnel me-2"></i>
      Wyszukiwanie i sortowanie
    </h5>
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label for="search" class="form-label">
          <i class="bi bi-search me-1"></i>
          Wyszukaj
        </label>
        <input type="text"
               name="search"
               id="search"
               class="form-control"
               placeholder="ID klienta, NIP, nazwa, email, nr sprawy"
               value="{{ search_query }}">
      </div>
      <div class="col-md-3">
        <label for="sort_by" class="form-label">
          <i class="bi bi-sort-down me-1"></i>
          Sortuj według
        </label>
        <select name="sort_by"
                id="sort_by"
                class="form-select"
                title="Wybierz pole, według którego chcesz sortować dane">
          <option value="case_number" {% if sort_by=='case_number' %}selected{% endif %}>Numer Sprawy</option>
          <option value="client_id" {% if sort_by=='client_id' %}selected{% endif %}>ID Klienta</option>
          <option value="client_company_name" {% if sort_by=='client_company_name' %}selected{% endif %}>Nazwa</option>
          <option value="client_nip" {% if sort_by=='client_nip' %}selected{% endif %}>NIP</option>
          <option value="client_email" {% if sort_by=='client_email' %}selected{% endif %}>Email</option>
          <option value="total_debt" {% if sort_by=='total_debt' %}selected{% endif %}>Kwota Zadłużenia</option>
          <option value="days_diff" {% if sort_by=='days_diff' %}selected{% endif %}>Dni po terminie</option>
          <option value="progress_percent" {% if sort_by=='progress_percent' %}selected{% endif %}>Postęp windykacji</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="sort_order" class="form-label">
          <i class="bi bi-arrow-down-up me-1"></i>
          Kierunek
        </label>
        <select name="sort_order"
                id="sort_order"
                class="form-select"
                title="Wybierz kierunek sortowania">
          <option value="asc" {% if sort_order=='asc' %}selected{% endif %}>Rosnąco</option>
          <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>Malejąco</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label d-none d-md-block">&nbsp;</label>
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search me-1"></i>
          Zastosuj
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Cases Table -->
<div class="card-custom mb-4">
  <div class="table-responsive">
    <table class="table-custom">
      <thead>
        <tr>
          <th>
            <i class="bi bi-hash me-1"></i>
            Numer Sprawy
          </th>
          <th>
            <i class="bi bi-person-badge me-1"></i>
            ID Klienta
          </th>
          <th>
            <i class="bi bi-building me-1"></i>
            Nazwa
          </th>
          <th>
            <i class="bi bi-card-list me-1"></i>
            NIP
          </th>
          <th>
            <i class="bi bi-envelope me-1"></i>
            Email
          </th>
          <th>
            <i class="bi bi-cash me-1"></i>
            Kwota Zadłużenia (zł)
          </th>
          <th>
            <i class="bi bi-calendar-event me-1"></i>
            Dni od/do terminu
          </th>
          <th>
            <i class="bi bi-bar-chart me-1"></i>
            Postęp
          </th>
        </tr>
      </thead>
      <tbody>
        {% for c in cases %}
        <tr>
          <td>
            <a href="{{ url_for('case_detail', case_number=c.case_number) }}" class="badge-custom badge-primary badge-clickable">
              {{ c.case_number }}
            </a>
          </td>
          <td>{{ c.client_id }}</td>
          <td>
            <a href="{{ url_for('client_cases', client_id=c.client_id) }}" class="link-primary">
              <i class="bi bi-box-arrow-up-right me-1"></i>
              {{ c.client_company_name }}
            </a>
          </td>
          <td>{{ c.client_nip }}</td>
          <td>
            <span class="text-muted">
              <i class="bi bi-envelope-at me-1"></i>
              {{ c.client_email }}
            </span>
          </td>
          <td>
            <strong>{{ "%.2f"|format(c.total_debt) }}</strong>
          </td>
          <td>
            {% if c.days_diff is not none %}
              {% if c.days_diff < 0 %}
                <span class="badge-custom badge-info">
                  <i class="bi bi-clock-history me-1"></i>
                  -{{ c.days_diff|abs }}
                </span>
              {% elif c.days_diff == 0 %}
                <span class="badge-custom badge-warning">
                  <i class="bi bi-exclamation-circle me-1"></i>
                  Dzisiaj
                </span>
              {% else %}
                <span class="badge-custom badge-danger">
                  <i class="bi bi-exclamation-triangle me-1"></i>
                  {{ c.days_diff }}
                </span>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>
            <div class="progress-custom">
              <div class="progress-bar-gradient"
                   role="progressbar"
                   style="width: {{ c.progress_percent }}%;"
                   aria-valuenow="{{ c.progress_percent }}"
                   aria-valuemin="0"
                   aria-valuemax="100">
                {{ c.progress_percent }}%
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination-info mb-3">
  <p>
    <i class="bi bi-file-earmark-text me-1"></i>
    Wyświetlanie <strong>{{ (page-1) * per_page + 1 }}</strong> -
    <strong>{{ page * per_page if page * per_page < total_count else total_count }}</strong>
    z <strong>{{ total_count }}</strong> spraw
  </p>
</div>

<nav aria-label="Paginacja">
  <ul class="pagination justify-content-center">
    {% if page > 1 %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('active_cases', page=1, search=search_query, sort_by=sort_by, sort_order=sort_order) }}"
           title="Pierwsza strona">
          <i class="bi bi-chevron-bar-left"></i>
        </a>
      </li>
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('active_cases', page=page-1, search=search_query, sort_by=sort_by, sort_order=sort_order) }}"
           title="Poprzednia strona">
          <i class="bi bi-chevron-left"></i>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-bar-left"></i>
        </span>
      </li>
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-left"></i>
        </span>
      </li>
    {% endif %}

    {% set start_page = [page - 2, 1]|max %}
    {% set end_page = [start_page + 4, total_pages]|min %}
    {% if end_page - start_page < 4 %}
      {% set start_page = [end_page - 4, 1]|max %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link"
           href="{{ url_for('active_cases', page=p, search=search_query, sort_by=sort_by, sort_order=sort_order) }}">
          {{ p }}
        </a>
      </li>
    {% endfor %}

    {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('active_cases', page=page+1, search=search_query, sort_by=sort_by, sort_order=sort_order) }}"
           title="Następna strona">
          <i class="bi bi-chevron-right"></i>
        </a>
      </li>
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('active_cases', page=total_pages, search=search_query, sort_by=sort_by, sort_order=sort_order) }}"
           title="Ostatnia strona">
          <i class="bi bi-chevron-bar-right"></i>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-right"></i>
        </span>
      </li>
      <li class="page-item disabled">
        <span class="page-link">
          <i class="bi bi-chevron-bar-right"></i>
        </span>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% endblock %}
