{% extends "layout.html" %}

{% block content %}
<div class="container-fluid mt-2">
  <h2 class="mb-4"> Panel Monitorowania Synchronizacji</h2>

  <!-- FILTROWANIE PO DACIE -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0"> Filtrowanie</h5>
    </div>
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label for="date_from" class="form-label">Od:</label>
          <input type="date" class="form-control" id="date_from" name="date_from"
                 value="{% if date_from %}{{ date_from.strftime('%Y-%m-%d') }}{% endif %}">
        </div>

        <div class="col-md-3">
          <label for="date_to" class="form-label">Do:</label>
          <input type="date" class="form-control" id="date_to" name="date_to"
                 value="{% if date_to %}{{ date_to.strftime('%Y-%m-%d') }}{% endif %}">
        </div>

        <div class="col-md-6 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">Filtruj</button>
          <button type="submit" name="preset" value="today" class="btn btn-outline-secondary me-2">Dzi</button>
          <button type="submit" name="preset" value="7days" class="btn btn-outline-secondary me-2">7 dni</button>
          <button type="submit" name="preset" value="30days" class="btn btn-outline-secondary me-2">30 dni</button>
          <a href="{{ url_for('sync_status') }}" class="btn btn-outline-danger">Wyczy</a>
        </div>
      </form>
    </div>
  </div>

  <!-- TABELA SYNCHRONIZACJI -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th style="width: 5%;">ID</th>
          <th style="width: 15%;">Typ synchronizacji</th>
          <th style="width: 10%;">Nowe Sprawy</th>
          <th style="width: 12%;">Opacone Sprawy</th>
          <th style="width: 10%;">Wywoania API</th>
          <th style="width: 10%;">Czas (s)</th>
          <th style="width: 18%;">Data i godzina (PL)</th>
        </tr>
      </thead>
      <tbody>
        {% for s in statuses %}
        <tr>
          <td>{{ s.id }}</td>
          <td>
            <span class="badge {% if s.sync_type == 'full' %}bg-success{% elif s.sync_type == 'new' %}bg-primary{% else %}bg-secondary{% endif %}">
              {{ SYNC_TYPE_DISPLAY.get(s.sync_type, s.sync_type) }}
            </span>
          </td>
          <td class="text-center">{{ s.new_cases or 0 }}</td>
          <td class="text-center">{{ s.closed_cases or 0 }}</td>
          <td class="text-center">{{ s.api_calls or 0 }}</td>
          <td class="text-center">
            <span class="{% if s.duration > 30 %}text-danger fw-bold{% elif s.duration > 15 %}text-warning fw-semibold{% else %}text-success{% endif %}">
              {{ "%.2f"|format(s.duration) }}
            </span>
          </td>
          <td>
            {{ s.local_timestamp.strftime('%Y-%m-%d %H:%M:%S') if s.local_timestamp else s.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
            <small class="text-muted">(PL)</small>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">
            Brak rekord贸w synchronizacji {% if date_from or date_to %}w wybranym okresie{% endif %}.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PAGINACJA -->
  {% if pagination and pagination.pages > 1 %}
  <nav aria-label="Nawigacja strony" class="mt-3">
    <ul class="pagination justify-content-center">
      <!-- Poprzednia -->
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a class="page-link" href="?page={{ pagination.prev_num }}{% if date_from %}&date_from={{ date_from.strftime('%Y-%m-%d') }}{% endif %}{% if date_to %}&date_to={{ date_to.strftime('%Y-%m-%d') }}{% endif %}">
          Poprzednia
        </a>
      </li>

      <!-- Strony -->
      {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if page_num %}
          <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
            <a class="page-link" href="?page={{ page_num }}{% if date_from %}&date_from={{ date_from.strftime('%Y-%m-%d') }}{% endif %}{% if date_to %}&date_to={{ date_to.strftime('%Y-%m-%d') }}{% endif %}">
              {{ page_num }}
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}

      <!-- Nastpna -->
      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a class="page-link" href="?page={{ pagination.next_num }}{% if date_from %}&date_from={{ date_from.strftime('%Y-%m-%d') }}{% endif %}{% if date_to %}&date_to={{ date_to.strftime('%Y-%m-%d') }}{% endif %}">
          Nastpna
        </a>
      </li>
    </ul>

    <p class="text-center text-muted">
      Strona {{ pagination.page }} z {{ pagination.pages }} (cznie {{ pagination.total }} rekord贸w)
    </p>
  </nav>
  {% endif %}

  <!-- PRZYCISK POWROTU -->
  <div class="mt-4">
    <a href="{{ url_for('active_cases') }}" class="btn btn-primary"> Powr贸t do panelu g贸wnego</a>
  </div>
</div>

<style>
/* Badge styling */
.badge {
  font-size: 0.85rem;
  padding: 0.4em 0.6em;
}

/* Wyr贸wnanie tekst贸w */
.text-center {
  text-align: center;
}

/* Paginacja */
.pagination .page-item.active .page-link {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.pagination .page-link {
  color: #0d6efd;
}

.pagination .page-link:hover {
  background-color: #e7f1ff;
}

/* Tabela - responsywno */
@media (max-width: 768px) {
  table {
    font-size: 0.85rem;
  }

  .badge {
    font-size: 0.75rem;
    padding: 0.3em 0.5em;
  }
}
</style>
{% endblock %}
