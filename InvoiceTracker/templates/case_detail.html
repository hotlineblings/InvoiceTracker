{% extends "layout.html" %}
{% block content %}

<!-- Page Header -->
<div class="mb-4">
  <h2 class="page-title">
    <i class="bi bi-file-earmark-text me-2"></i>
    Szczegóły Sprawy: <span class="badge-custom badge-primary">{{ case.case_number }}</span>
  </h2>
</div>

<!-- Client Data Card -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-person-vcard me-2"></i>
      Dane Klienta
    </h5>
    <div class="row">
      <div class="col-md-6">
        <div class="info-item mb-3">
          <label class="info-label">
            <i class="bi bi-person-badge me-1"></i>
            ID Klienta
          </label>
          <div class="info-value">{{ case.client_id }}</div>
        </div>
        <div class="info-item mb-3">
          <label class="info-label">
            <i class="bi bi-building me-1"></i>
            Nazwa firmy
          </label>
          <div class="info-value">{{ case.client_company_name }}</div>
        </div>
        <div class="info-item mb-3">
          <label class="info-label">
            <i class="bi bi-card-list me-1"></i>
            NIP
          </label>
          <div class="info-value">{{ invoice.client_nip }}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="info-item mb-3">
          <label class="info-label">
            <i class="bi bi-envelope-at me-1"></i>
            Email
          </label>
          <div class="info-value">
            <span id="email-display-{{ invoice.id }}">
              {{ invoice.get_effective_email() if invoice.get_effective_email() else "Brak" }}
              {% if invoice.override_email %}
                <span class="badge-custom badge-warning ms-2" title="Email nadpisany przez administratora">
                  <i class="bi bi-exclamation-triangle-fill me-1"></i>
                  Override
                </span>
              {% endif %}
            </span>
            <button type="button"
                    class="btn btn-sm btn-link p-0 ms-2"
                    onclick="toggleEmailEdit{{ invoice.id }}()"
                    id="edit-btn-{{ invoice.id }}"
                    title="Edytuj email">
              <i class="bi bi-pencil-square"></i>
            </button>

            <!-- Email Edit Form -->
            <div id="email-edit-form-{{ invoice.id }}" style="display:none;" class="mt-2">
              <form id="form-{{ invoice.id }}" onsubmit="return submitEmailUpdate{{ invoice.id }}(event)">
                <div class="input-group">
                  <input type="email"
                         name="new_email"
                         class="form-control"
                         value="{{ invoice.override_email if invoice.override_email else invoice.client_email }}"
                         placeholder="Nowy email"
                         id="email-input-{{ invoice.id }}">
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-lg me-1"></i>
                    Zapisz
                  </button>
                  <button type="button"
                          class="btn btn-secondary"
                          onclick="toggleEmailEdit{{ invoice.id }}()">
                    <i class="bi bi-x-lg me-1"></i>
                    Anuluj
                  </button>
                </div>
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  Email z API: {{ invoice.client_email if invoice.client_email else "Brak" }}
                </small>
              </form>
            </div>

            <script>
            function toggleEmailEdit{{ invoice.id }}() {
              const display = document.getElementById('email-display-{{ invoice.id }}');
              const form = document.getElementById('email-edit-form-{{ invoice.id }}');
              const editBtn = document.getElementById('edit-btn-{{ invoice.id }}');

              if (form.style.display === 'none') {
                display.style.display = 'none';
                editBtn.style.display = 'none';
                form.style.display = 'block';
              } else {
                display.style.display = 'inline';
                editBtn.style.display = 'inline';
                form.style.display = 'none';
              }
            }

            async function submitEmailUpdate{{ invoice.id }}(e) {
              e.preventDefault();
              const formData = new FormData(e.target);
              // Dodaj CSRF token z meta tagu
              const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
              formData.append('csrf_token', csrfToken);

              try {
                const response = await fetch('{{ url_for("settings.update_email", invoice_id=invoice.id) }}', {
                  method: 'POST',
                  body: formData
                });

                const data = await response.json();

                if (data.success) {
                  alert('Email zaktualizowany: ' + data.effective_email);
                  location.reload();
                } else {
                  alert('Błąd: ' + data.message);
                }
              } catch (error) {
                alert('Błąd połączenia: ' + error);
              }
              return false;
            }
            </script>
          </div>
        </div>
        <div class="info-item mb-3">
          <label class="info-label">
            <i class="bi bi-geo-alt me-1"></i>
            Adres
          </label>
          <div class="info-value">
            {% if invoice.client_address %}
              {{ invoice.client_address }}
            {% else %}
              <span class="text-muted">Brak</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Data Card -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-receipt me-2"></i>
      Dane Faktury
    </h5>
    <div class="table-responsive">
      <table class="table-custom">
        <thead>
          <tr>
            <th>
              <i class="bi bi-hash me-1"></i>
              Numer Faktury
            </th>
            <th>
              <i class="bi bi-calendar-check me-1"></i>
              Data Wystawienia
            </th>
            <th>
              <i class="bi bi-calendar-event me-1"></i>
              Termin Płatności
            </th>
            <th>
              <i class="bi bi-cash me-1"></i>
              Kwota (zł)
            </th>
            <th>
              <i class="bi bi-cash-coin me-1"></i>
              Zapłacono (zł)
            </th>
            <th>
              <i class="bi bi-exclamation-circle me-1"></i>
              Pozostało (zł)
            </th>
            <th>
              <i class="bi bi-currency-exchange me-1"></i>
              Waluta
            </th>
            <th>
              <i class="bi bi-clock-history me-1"></i>
              Dni po terminie
            </th>
            <th>
              <i class="bi bi-bar-chart me-1"></i>
              Postęp
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <span class="badge-custom badge-info">{{ invoice.invoice_number }}</span>
            </td>
            <td>
              {% if invoice.invoice_date %}
                {{ invoice.invoice_date.strftime('%Y-%m-%d') }}
              {% else %}
                <span class="text-muted">Brak</span>
              {% endif %}
            </td>
            <td>
              {% if invoice.payment_due_date %}
                {{ invoice.payment_due_date.strftime('%Y-%m-%d') }}
              {% else %}
                <span class="text-muted">Brak</span>
              {% endif %}
            </td>
            <td>
              <strong>{{ "%.2f"|format(invoice.gross_price/100 if invoice.gross_price else 0) }}</strong>
            </td>
            <td>
              {% if invoice.paid_price %}
                {{ "%.2f"|format(invoice.paid_price/100) }}
              {% else %}
                0.00
              {% endif %}
            </td>
            <td>
              {% if left_to_pay %}
                <span class="text-danger">
                  <strong>{{ "%.2f"|format(left_to_pay/100) }}</strong>
                </span>
              {% else %}
                0.00
              {% endif %}
            </td>
            <td>{{ invoice.currency or "PLN" }}</td>
            <td>
              {% if days_display is not none %}
                {% if days_display < 0 %}
                  <span class="badge-custom badge-info">
                    <i class="bi bi-clock-history me-1"></i>
                    -{{ days_display|abs }}
                  </span>
                {% elif days_display == 0 %}
                  <span class="badge-custom badge-warning">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    Dzisiaj
                  </span>
                {% else %}
                  <span class="badge-custom badge-danger">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {{ days_display }}
                  </span>
                {% endif %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="progress-custom">
                <div class="progress-bar-gradient"
                     role="progressbar"
                     style="width: {{ progress_percent }}%;"
                     aria-valuenow="{{ progress_percent }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                  {{ progress_percent }}%
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Case Actions Card -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-gear me-2"></i>
      Akcje
    </h5>
    <div class="d-flex gap-2 flex-wrap">
      {% if case.status != "active" %}
        <form method="post" action="{{ url_for('cases.reopen_case') }}" style="display:inline;">
          {{ reopen_form.hidden_tag() }}
          <input type="hidden" name="case_number" value="{{ case.case_number }}">
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-arrow-counterclockwise me-1"></i>
            Przywróć do spraw aktywnych
          </button>
        </form>
      {% elif invoice.status != "opłacona" %}
        <form method="post" action="{{ url_for('cases.mark_invoice_paid', invoice_id=invoice.id) }}" style="display:inline;">
          {{ mark_paid_form.hidden_tag() }}
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle me-1"></i>
            Oznacz jako opłaconą / Zamknij sprawę
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<!-- Manual Notifications Card -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-send me-2"></i>
      Ręczne wysyłanie powiadomień
    </h5>
    <div class="d-flex gap-2 flex-wrap">
      <form method="post" action="{{ url_for('cases.send_manual') }}" style="display:inline;">
        {{ send_manual_form.hidden_tag() }}
        <input type="hidden" name="case_number" value="{{ case.case_number }}">
        <input type="hidden" name="stage" value="przeds">
        <button type="submit" class="btn btn-secondary">
          <i class="bi bi-1-circle me-1"></i>
          1 dzień przed
        </button>
      </form>
      <form method="post" action="{{ url_for('cases.send_manual') }}" style="display:inline;">
        {{ send_manual_form.hidden_tag() }}
        <input type="hidden" name="case_number" value="{{ case.case_number }}">
        <input type="hidden" name="stage" value="7dni">
        <button type="submit" class="btn btn-secondary">
          <i class="bi bi-2-circle me-1"></i>
          7 dni po
        </button>
      </form>
      <form method="post" action="{{ url_for('cases.send_manual') }}" style="display:inline;">
        {{ send_manual_form.hidden_tag() }}
        <input type="hidden" name="case_number" value="{{ case.case_number }}">
        <input type="hidden" name="stage" value="14dni">
        <button type="submit" class="btn btn-secondary">
          <i class="bi bi-3-circle me-1"></i>
          14 dni po
        </button>
      </form>
      <form method="post" action="{{ url_for('cases.send_manual') }}" style="display:inline;">
        {{ send_manual_form.hidden_tag() }}
        <input type="hidden" name="case_number" value="{{ case.case_number }}">
        <input type="hidden" name="stage" value="21dni">
        <button type="submit" class="btn btn-secondary">
          <i class="bi bi-4-circle me-1"></i>
          21 dni po
        </button>
      </form>
      <form method="post" action="{{ url_for('cases.send_manual') }}" style="display:inline;">
        {{ send_manual_form.hidden_tag() }}
        <input type="hidden" name="case_number" value="{{ case.case_number }}">
        <input type="hidden" name="stage" value="30dni">
        <button type="submit" class="btn btn-secondary">
          <i class="bi bi-5-circle me-1"></i>
          30 dni po
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Notification History Card -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">
      <i class="bi bi-clock-history me-2"></i>
      Historia wysłanych powiadomień
    </h5>
    {% if notifications and notifications|length > 0 %}
      <div class="timeline">
        {% for log in notifications %}
        <div class="timeline-item">
          <div class="timeline-marker">
            <i class="bi bi-envelope-check"></i>
          </div>
          <div class="timeline-content">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1">
                  <span class="badge-custom badge-info">{{ log.stage }}</span>
                  {{ log.subject }}
                </h6>
                <small class="text-muted">
                  <i class="bi bi-calendar3 me-1"></i>
                  {{ log.sent_at.strftime('%Y-%m-%d %H:%M:%S') if log.sent_at else '' }}
                </small>
              </div>
              <button class="btn btn-sm btn-secondary"
                      data-bs-toggle="modal"
                      data-bs-target="#logModal{{ log.id }}">
                <i class="bi bi-eye me-1"></i>
                Podgląd
              </button>
            </div>
          </div>
        </div>

        <!-- Modal for notification preview -->
        <div class="modal fade" id="logModal{{ log.id }}" tabindex="-1" aria-labelledby="logModalLabel{{ log.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="logModalLabel{{ log.id }}">
                  <i class="bi bi-envelope-open me-2"></i>
                  {{ log.subject }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <strong>
                    <i class="bi bi-tag me-1"></i>
                    Etap:
                  </strong>
                  <span class="badge-custom badge-info">{{ log.stage }}</span>
                </div>
                <div class="mb-3">
                  <strong>
                    <i class="bi bi-calendar3 me-1"></i>
                    Data wysłania:
                  </strong>
                  {{ log.sent_at.strftime('%Y-%m-%d %H:%M:%S') if log.sent_at else '' }}
                </div>
                <div>
                  <strong>
                    <i class="bi bi-file-text me-1"></i>
                    Treść wiadomości:
                  </strong>
                  <pre class="mt-2 p-3 rounded" style="background-color: var(--color-bg-secondary); border: 1px solid var(--color-border); max-height: 400px; overflow-y: auto;">{{ log.body }}</pre>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="bi bi-x-lg me-1"></i>
                  Zamknij
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info alert-custom mb-0">
        <i class="bi bi-info-circle me-2"></i>
        Brak wysłanych powiadomień.
      </div>
    {% endif %}
  </div>
</div>

<!-- Back Button -->
<div class="mb-4">
  <a href="{{ url_for('cases.active_cases') }}" class="btn btn-primary">
    <i class="bi bi-arrow-left me-1"></i>
    Powrót do listy spraw
  </a>
</div>

{% endblock %}
