{% extends "layout.html" %}
{% block content %}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="page-title">
    <i class="bi bi-building me-2"></i>
    Lista Spraw Klienta
  </h2>
  <form method="post" action="{{ url_for('sync.manual_sync') }}" class="m-0">
    {{ sync_form.hidden_tag() }}
    <button type="submit" class="btn btn-info">
      <i class="bi bi-arrow-clockwise me-1"></i>
      Ręcznie Synchronizuj
    </button>
  </form>
</div>

<!-- Client Details Card -->
{% if client_details %}
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title">
      <i class="bi bi-person-vcard me-2"></i>
      Informacje o kliencie
    </h5>
    <div class="row">
      <div class="col-md-3">
        <div class="info-item">
          <label class="info-label">
            <i class="bi bi-building me-1"></i>
            Nazwa Firmy
          </label>
          <div class="info-value">{{ client_details.client_company_name }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="info-item">
          <label class="info-label">
            <i class="bi bi-card-list me-1"></i>
            NIP
          </label>
          <div class="info-value">{{ client_details.client_nip }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="info-item">
          <label class="info-label">
            <i class="bi bi-envelope-at me-1"></i>
            Email
          </label>
          <div class="info-value">{{ client_details.client_email }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="info-item">
          <label class="info-label">
            <i class="bi bi-geo-alt me-1"></i>
            Adres
          </label>
          <div class="info-value">{{ client_details.client_address if client_details.client_address else "Brak" }}</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Stats Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-6">
    <div class="card-custom card-gradient-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-white-50 mb-1">Łączna kwota zadłużenia</p>
            <h3 class="mb-0 text-white">{{ "%.2f"|format(total_debt_all) }} zł</h3>
          </div>
          <div class="stat-icon">
            <i class="bi bi-cash-stack"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card-custom card-gradient-secondary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-white-50 mb-1">Liczba spraw aktywnych</p>
            <h3 class="mb-0 text-white">{{ active_count }}</h3>
          </div>
          <div class="stat-icon">
            <i class="bi bi-folder-open"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Active Cases Section -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title">
      <i class="bi bi-folder-open me-2"></i>
      Aktywne sprawy
    </h5>
    <div class="table-responsive">
      <table class="table-custom">
        <thead>
          <tr>
            <th>
              <i class="bi bi-hash me-1"></i>
              Numer Sprawy
            </th>
            <th>
              <i class="bi bi-building me-1"></i>
              Nazwa
            </th>
            <th>
              <i class="bi bi-card-list me-1"></i>
              NIP
            </th>
            <th>
              <i class="bi bi-envelope me-1"></i>
              Email
            </th>
            <th>
              <i class="bi bi-cash me-1"></i>
              Kwota Zadłużenia (zł)
            </th>
            <th>
              <i class="bi bi-calendar-event me-1"></i>
              Dni od/do terminu
            </th>
            <th>
              <i class="bi bi-bar-chart me-1"></i>
              Postęp
            </th>
          </tr>
        </thead>
        <tbody>
          {% for c in active_cases %}
          <tr>
            <td>
              <a href="{{ url_for('cases.case_detail', case_number=c.case_number) }}" class="badge-custom badge-primary badge-clickable">
                {{ c.case_number }}
              </a>
            </td>
            <td>{{ c.client_company_name }}</td>
            <td>{{ c.client_nip }}</td>
            <td>
              <span id="email-display-active-{{ c.invoice_id }}">
                {{ c.client_email }}
                {% if c.override_email %}
                  <span class="badge-custom badge-warning ms-1" title="Override">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                  </span>
                {% endif %}
              </span>
              <button type="button"
                      class="btn btn-sm btn-link p-0 ms-1"
                      onclick="toggleEditActive{{ c.invoice_id }}()"
                      id="edit-btn-active-{{ c.invoice_id }}"
                      title="Edytuj email">
                <i class="bi bi-pencil-square"></i>
              </button>
              <div id="edit-form-active-{{ c.invoice_id }}" style="display:none;" class="mt-2">
                <form onsubmit="return submitUpdateActive{{ c.invoice_id }}(event)">
                  <div class="input-group input-group-sm">
                    <input type="email"
                           name="new_email"
                           class="form-control"
                           value="{{ c.override_email if c.override_email else c.api_email }}"
                           placeholder="Email">
                    <button type="submit" class="btn btn-success btn-sm">
                      <i class="bi bi-check-lg"></i>
                    </button>
                    <button type="button"
                            class="btn btn-secondary btn-sm"
                            onclick="toggleEditActive{{ c.invoice_id }}()">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    API: {{ c.api_email }}
                  </small>
                </form>
              </div>
              <script>
              function toggleEditActive{{ c.invoice_id }}() {
                const display = document.getElementById('email-display-active-{{ c.invoice_id }}');
                const form = document.getElementById('edit-form-active-{{ c.invoice_id }}');
                const btn = document.getElementById('edit-btn-active-{{ c.invoice_id }}');
                if (form.style.display === 'none') {
                  display.style.display = 'none';
                  btn.style.display = 'none';
                  form.style.display = 'block';
                } else {
                  display.style.display = 'inline';
                  btn.style.display = 'inline';
                  form.style.display = 'none';
                }
              }
              async function submitUpdateActive{{ c.invoice_id }}(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                formData.append('csrf_token', csrfToken);
                try {
                  const response = await fetch('{{ url_for("settings.update_email", invoice_id=c.invoice_id) }}', {
                    method: 'POST',
                    body: formData
                  });
                  const data = await response.json();
                  if (data.success) {
                    alert('Email zaktualizowany: ' + data.effective_email);
                    location.reload();
                  } else {
                    alert('Błąd: ' + data.message);
                  }
                } catch (error) {
                  alert('Błąd połączenia: ' + error);
                }
                return false;
              }
              </script>
            </td>
            <td>
              <strong>{{ "%.2f"|format(c.total_debt) }}</strong>
            </td>
            <td>
              {% if c.days_diff is not none %}
                {% if c.days_diff < 0 %}
                  <span class="badge-custom badge-info">
                    <i class="bi bi-clock-history me-1"></i>
                    -{{ c.days_diff|abs }}
                  </span>
                {% elif c.days_diff == 0 %}
                  <span class="badge-custom badge-warning">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    Dzisiaj
                  </span>
                {% else %}
                  <span class="badge-custom badge-danger">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {{ c.days_diff }}
                  </span>
                {% endif %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="progress-custom">
                <div class="progress-bar-gradient"
                     role="progressbar"
                     style="width: {{ c.progress_percent }}%;"
                     aria-valuenow="{{ c.progress_percent }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                  {{ c.progress_percent }}%
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Completed Cases Section -->
<div class="card-custom mb-4">
  <div class="card-body">
    <h5 class="card-title">
      <i class="bi bi-folder-check me-2"></i>
      Zakończone sprawy
    </h5>
    <div class="table-responsive">
      <table class="table-custom">
        <thead>
          <tr>
            <th>
              <i class="bi bi-hash me-1"></i>
              Numer Sprawy
            </th>
            <th>
              <i class="bi bi-building me-1"></i>
              Nazwa
            </th>
            <th>
              <i class="bi bi-card-list me-1"></i>
              NIP
            </th>
            <th>
              <i class="bi bi-envelope me-1"></i>
              Email
            </th>
            <th>
              <i class="bi bi-cash me-1"></i>
              Kwota Zadłużenia (zł)
            </th>
            <th>
              <i class="bi bi-calendar-event me-1"></i>
              Dni od/do terminu
            </th>
            <th>
              <i class="bi bi-bar-chart me-1"></i>
              Postęp
            </th>
          </tr>
        </thead>
        <tbody>
          {% for c in completed_cases %}
          <tr>
            <td>
              <a href="{{ url_for('cases.case_detail', case_number=c.case_number) }}" class="badge-custom badge-success badge-clickable">
                {{ c.case_number }}
              </a>
            </td>
            <td>{{ c.client_company_name }}</td>
            <td>{{ c.client_nip }}</td>
            <td>
              <span id="email-display-completed-{{ c.invoice_id }}">
                {{ c.client_email }}
                {% if c.override_email %}
                  <span class="badge-custom badge-warning ms-1" title="Override">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                  </span>
                {% endif %}
              </span>
              <button type="button"
                      class="btn btn-sm btn-link p-0 ms-1"
                      onclick="toggleEditCompleted{{ c.invoice_id }}()"
                      id="edit-btn-completed-{{ c.invoice_id }}"
                      title="Edytuj email">
                <i class="bi bi-pencil-square"></i>
              </button>
              <div id="edit-form-completed-{{ c.invoice_id }}" style="display:none;" class="mt-2">
                <form onsubmit="return submitUpdateCompleted{{ c.invoice_id }}(event)">
                  <div class="input-group input-group-sm">
                    <input type="email"
                           name="new_email"
                           class="form-control"
                           value="{{ c.override_email if c.override_email else c.api_email }}"
                           placeholder="Email">
                    <button type="submit" class="btn btn-success btn-sm">
                      <i class="bi bi-check-lg"></i>
                    </button>
                    <button type="button"
                            class="btn btn-secondary btn-sm"
                            onclick="toggleEditCompleted{{ c.invoice_id }}()">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    API: {{ c.api_email }}
                  </small>
                </form>
              </div>
              <script>
              function toggleEditCompleted{{ c.invoice_id }}() {
                const display = document.getElementById('email-display-completed-{{ c.invoice_id }}');
                const form = document.getElementById('edit-form-completed-{{ c.invoice_id }}');
                const btn = document.getElementById('edit-btn-completed-{{ c.invoice_id }}');
                if (form.style.display === 'none') {
                  display.style.display = 'none';
                  btn.style.display = 'none';
                  form.style.display = 'block';
                } else {
                  display.style.display = 'inline';
                  btn.style.display = 'inline';
                  form.style.display = 'none';
                }
              }
              async function submitUpdateCompleted{{ c.invoice_id }}(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                formData.append('csrf_token', csrfToken);
                try {
                  const response = await fetch('{{ url_for("settings.update_email", invoice_id=c.invoice_id) }}', {
                    method: 'POST',
                    body: formData
                  });
                  const data = await response.json();
                  if (data.success) {
                    alert('Email zaktualizowany: ' + data.effective_email);
                    location.reload();
                  } else {
                    alert('Błąd: ' + data.message);
                  }
                } catch (error) {
                  alert('Błąd połączenia: ' + error);
                }
                return false;
              }
              </script>
            </td>
            <td>
              <strong>{{ "%.2f"|format(c.total_debt) }}</strong>
            </td>
            <td>
              {% if c.days_diff is not none %}
                {% if c.days_diff < 0 %}
                  <span class="badge-custom badge-info">
                    <i class="bi bi-clock-history me-1"></i>
                    -{{ c.days_diff|abs }}
                  </span>
                {% else %}
                  <span class="badge-custom badge-danger">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {{ c.days_diff }}
                  </span>
                {% endif %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <div class="progress-custom">
                <div class="progress-bar-gradient"
                     role="progressbar"
                     style="width: {{ c.progress_percent }}%;"
                     aria-valuenow="{{ c.progress_percent }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                  {{ c.progress_percent }}%
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Back Button -->
<div class="mb-4">
  <a href="{{ url_for('cases.active_cases') }}" class="btn btn-primary">
    <i class="bi bi-arrow-left me-1"></i>
    Powrót do aktywnych spraw
  </a>
</div>

{% endblock %}
